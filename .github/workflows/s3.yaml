name: Deploy Private S3 + CloudFront OAC

on: workflow_dispatch
  

env:
  BUCKET_NAME: private-s3-oac-${{ github.run_id }}
  ORIGIN_ID: s3-origin
  CF_COMMENT: Private S3 via CloudFront OAC

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: "ap-south-1"

      - name: Create private S3 bucket
        run: |
          aws s3api create-bucket \
            --bucket $BUCKET_NAME \
            --region $AWS_REGION \
            --create-bucket-configuration LocationConstraint=$AWS_REGION

          aws s3api put-public-access-block \
            --bucket $BUCKET_NAME \
            --public-access-block-configuration \
              BlockPublicAcls=true,IgnorePublicAcls=true,BlockPublicPolicy=true,RestrictPublicBuckets=true

      - name: Upload index.html
        run: |
          aws s3 cp index.html s3://$BUCKET_NAME/index.html \
            --content-type text/html

      - name: Create CloudFront Origin Access Control
        id: oac
        run: |
          OAC_ID=$(aws cloudfront create-origin-access-control \
            --origin-access-control-config '{
              "Name": "s3-oac-'${{ github.run_id }}'",
              "Description": "OAC for private S3",
              "SigningProtocol": "sigv4",
              "SigningBehavior": "always",
              "OriginAccessControlOriginType": "s3"
            }' \
            --query "OriginAccessControl.Id" \
            --output text)

          echo "OAC_ID=$OAC_ID" >> $GITHUB_ENV

      - name: Create CloudFront distribution
        id: cf
        run: |
          DIST_ID=$(aws cloudfront create-distribution \
            --distribution-config '{
              "CallerReference": "'${{ github.run_id }}'",
              "Comment": "'$CF_COMMENT'",
              "Enabled": true,
              "DefaultRootObject": "index.html",
              "Origins": {
                "Quantity": 1,
                "Items": [{
                  "Id": "'$ORIGIN_ID'",
                  "DomainName": "'$BUCKET_NAME'.s3.'$AWS_REGION'.amazonaws.com",
                  "S3OriginConfig": {
                    "OriginAccessIdentity": ""
                  },
                  "OriginAccessControlId": "'$OAC_ID'"
                }]
              },
              "DefaultCacheBehavior": {
                "TargetOriginId": "'$ORIGIN_ID'",
                "ViewerProtocolPolicy": "redirect-to-https",
                "AllowedMethods": {
                  "Quantity": 2,
                  "Items": ["GET", "HEAD"]
                },
                "CachedMethods": {
                  "Quantity": 2,
                  "Items": ["GET", "HEAD"]
                },
                "ForwardedValues": {
                  "QueryString": false,
                  "Cookies": { "Forward": "none" }
                }
              },
              "ViewerCertificate": {
                "CloudFrontDefaultCertificate": true
              }
            }' \
            --query "Distribution.Id" \
            --output text)

          DOMAIN=$(aws cloudfront get-distribution \
            --id $DIST_ID \
            --query "Distribution.DomainName" \
            --output text)

          echo "DIST_ID=$DIST_ID" >> $GITHUB_ENV
          echo "CF_DOMAIN=$DOMAIN" >> $GITHUB_ENV

      - name: Attach bucket policy for CloudFront OAC
        run: |
          aws s3api put-bucket-policy \
            --bucket $BUCKET_NAME \
            --policy '{
              "Version": "2012-10-17",
              "Statement": [{
                "Effect": "Allow",
                "Principal": {
                  "Service": "cloudfront.amazonaws.com"
                },
                "Action": "s3:GetObject",
                "Resource": "arn:aws:s3:::'"$BUCKET_NAME"'/*",
                "Condition": {
                  "StringEquals": {
                    "AWS:SourceArn": "arn:aws:cloudfront::'$(aws sts get-caller-identity --query Account --output text)':distribution/'"$DIST_ID"'"
                  }
                }
              }]
            }'

      - name: Output CloudFront URL
        run: |
          echo "======================================="
          echo "CloudFront URL:"
          echo "https://$CF_DOMAIN"
          echo "======================================="
